<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>华容道（by Arthur）</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --console-bg: #1a1a1a;
            --board-inner: #111;
            --border-color: #000;
            --lcd-bg: #203025;
            --lcd-text: #00ffaa;
            
            /* 棋子颜色 - 调深一点增加厚重感 */
            --cc-base: #b03a2e; --cc-light: #e74c3c;
            --gen-base: #21618c; --gen-light: #3498db;
            --sol-base: #d68910; --sol-light: #f1c40f;
        }

        * {
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            /* 背景纹理 */
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
            width: 100%;
            max-width: 420px;
        }

        h1 {
            font-size: 1.3rem;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 1px;
            color: #fff;
            font-weight: 600;
        }

        .btn-icon {
            background: linear-gradient(145deg, #444, #222);
            border: 1px solid #555;
            color: #ddd;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.4);
            font-size: 0.9rem;
        }

        /* 游戏机外壳 */
        .console-frame {
            width: 94vmin;
            max-width: 430px;
            background: var(--console-bg);
            border-radius: 18px;
            padding: 18px;
            box-shadow: 
                0 30px 60px rgba(0,0,0,0.9),
                inset 0 1px 1px rgba(255,255,255,0.15),
                inset 0 -1px 1px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* 仪表盘 */
        .dashboard {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            background: #222;
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid #000;
            border-bottom: 2px solid #333; 
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.6);
        }

        .puzzle-selector {
            flex-grow: 1;
            margin-right: 15px;
        }
        
        .puzzle-selector label {
            display: block;
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 6px;
            font-weight: bold;
        }

        select {
            background: linear-gradient(to bottom, #333, #222);
            color: #eee;
            border: 1px solid #000;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.95rem;
            width: 100%;
            outline: none;
            box-shadow: 0 1px 0 rgba(255,255,255,0.08);
        }

        /* LCD 屏幕 */
        .lcd-screen {
            background: var(--lcd-bg);
            border: 2px solid #000;
            border-bottom: 2px solid #333;
            border-radius: 6px;
            padding: 6px 12px;
            text-align: right;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.9);
            min-width: 90px;
            position: relative;
            overflow: hidden;
        }
        .lcd-screen::after {
            content: ''; position: absolute; top:0; left:0; width:100%; height:40%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.05), transparent);
            pointer-events: none;
        }

        .lcd-label {
            font-size: 0.6rem;
            color: #4a6055;
            letter-spacing: 1px;
            margin-bottom: 0;
            text-align: center;
            font-weight: bold;
        }

        .lcd-number {
            font-family: "Courier New", Courier, monospace;
            font-weight: bold;
            color: var(--lcd-text);
            font-size: 1.6rem;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 255, 170, 0.5);
            line-height: 1.1;
            margin-top: 2px;
        }

        /* 
           棋盘外层包裹容器 
           修复：移除 overflow: hidden 以显示出口
        */
        .board-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            background: transparent;
            padding: 0;
            /* 关键：这里不能 hidden，否则出口的辉光会被切掉 */
            overflow: visible; 
        }

        /* 实际棋盘 */
        .board-container {
            position: relative;
            background-color: var(--board-inner);
            
            /* 边框设置 */
            border-left: 3px solid var(--border-color);
            border-right: 3px solid var(--border-color);
            border-top: 3px solid var(--border-color);
            
            box-shadow: inset 0 0 40px rgba(0,0,0,1);
            margin: 0 auto; 
        }

        /* 底部边框 - 中间断开效果 */
        .board-container::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: -3px;
            right: -3px;
            height: 3px;
            background: linear-gradient(to right, 
                var(--border-color) 0%, 
                var(--border-color) 25%, 
                transparent 25%, 
                transparent 75%, 
                var(--border-color) 75%, 
                var(--border-color) 100%
            );
            pointer-events: none;
            z-index: 20;
        }

        /* 出口高亮 - 优化显示位置和亮度 */
        .exit-floor {
            position: absolute;
            bottom: -6px; /* 稍微突出一点 */
            left: 25%;
            width: 50%;
            height: 6px;
            /* 强烈的荧光绿 */
            background: linear-gradient(to bottom, rgba(0, 255, 170, 0.3), rgba(0, 255, 170, 0.05));
            border-bottom: 2px solid rgba(0, 255, 170, 0.8);
            /* 增强发光 */
            box-shadow: 0 0 15px rgba(0, 255, 170, 0.4);
            z-index: 30; /* 确保在最上层 */
            
            /* 扫描线细节 */
            background-image: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 170, 0.1) 2px,
                rgba(0, 255, 170, 0.1) 4px
            );
            animation: pulseExit 3s ease-in-out infinite;
        }

        @keyframes pulseExit {
            0%, 100% { opacity: 0.6; box-shadow: 0 0 10px rgba(0, 255, 170, 0.3); }
            50% { opacity: 1; box-shadow: 0 0 20px rgba(0, 255, 170, 0.6); }
        }

        /* 棋子样式 - 质感增强版 */
        .block {
            position: absolute;
            border-radius: 5px;
            transition: top 0.1s ease-out, left 0.1s ease-out;
            cursor: grab; 
            z-index: 10;
            
            /* 3D 塑料质感：更厚重的投影 */
            box-shadow: 
                inset 1px 1px 0 rgba(255,255,255,0.3),
                inset -1px -1px 0 rgba(0,0,0,0.3),
                0 4px 6px rgba(0,0,0,0.5),
                0 0 0 1px rgba(0,0,0,0.8);
            
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .block:active { 
            cursor: grabbing; 
            transform: scale(0.97); 
        }

        /* 棋子表面凹槽 - 关键优化：加粗、等宽 */
        .block::after {
            content: ''; 
            position: absolute;
            /* 增加边距，让外框看起来更厚实 (8px) */
            top: 8px; bottom: 8px; left: 8px; right: 8px;
            
            border-radius: 3px;
            /* 增加线条粗细 (4px) */
            border: 4px solid rgba(0,0,0,0.15);
            border-bottom: 4px solid rgba(255,255,255,0.05); 
            border-right: 4px solid rgba(255,255,255,0.05);
            
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
            pointer-events: none;
        }

        /* 棋子配色 */
        .block.caocao { background: linear-gradient(145deg, var(--cc-light), var(--cc-base)); z-index: 15; }
        /* 注意：删除了三角形 */
        
        .block.general { background: linear-gradient(145deg, var(--gen-light), var(--gen-base)); }
        .block.soldier { background: linear-gradient(145deg, var(--sol-light), var(--sol-base)); }

        /* 表面微光，增加圆润感 */
        .block::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.15), transparent 65%);
            border-radius: 4px;
            pointer-events: none;
        }

        /* 底部按钮 */
        .controls {
            display: flex;
            justify-content: center;
        }

        .btn-ctrl {
            padding: 14px 50px;
            background: linear-gradient(to bottom, #3e3e3e, #2a2a2a);
            color: #ccc;
            border: 1px solid #000;
            border-top: 1px solid #555;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            text-shadow: 0 -1px 0 #000;
            transition: transform 0.1s;
        }
        .btn-ctrl:active { 
            background: #222;
            transform: translateY(2px); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.4); 
        }
        .btn-ctrl.primary {
             background: linear-gradient(to bottom, #e74c3c, #c0392b);
             color: white;
             border-top: 1px solid #ff7675;
             text-shadow: 0 -1px 0 #922b21;
        }

        /* 胜利提示 */
        #win-message {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(25, 25, 25, 0.96);
            color: #f1c40f;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #f1c40f;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            display: none; z-index: 50;
            min-width: 260px;
            backdrop-filter: blur(5px);
        }

        /* 规则弹窗 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; justify-content: center; align-items: center;
            z-index: 100; backdrop-filter: blur(5px);
        }
        .modal {
            background: #f5f5f5; color: #333; width: 85%; max-width: 400px;
            padding: 25px; border-radius: 12px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.9);
        }
        .modal h2 { margin-top: 0; color: #c0392b; border-bottom: 2px solid #ccc; padding-bottom: 12px; }
        .modal p { line-height: 1.6; font-size: 0.95rem; }
        .modal-footer {
            margin-top: 20px; padding-top: 15px; border-top: 1px solid #ccc;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.85rem; color: #666;
        }

    </style>
</head>
<body>

    <header>
        <h1>华容道（by Arthur）</h1>
        <div class="btn-icon" onclick="toggleRules()">?</div>
    </header>

    <div class="console-frame">
        <div class="dashboard">
            <div class="puzzle-selector">
                <label>选择经典关卡</label>
                <select id="puzzle-select" onchange="startGame()">
                    <!-- JS 填充 -->
                </select>
            </div>
            <div class="lcd-screen">
                <div class="lcd-label">当前步数</div>
                <div class="lcd-number" id="step-display">000</div>
            </div>
        </div>

        <div class="board-wrapper">
            <div class="board-container" id="board">
                <!-- 出口地板 -->
                <div class="exit-floor"></div>
                <!-- 棋子 -->
                
                <div id="win-message">
                    <h2 style="margin:0 0 15px 0; font-size:1.4rem; line-height:1.5;">太厉害了！<br>您已通过该经典关卡！</h2>
                    <p style="color: #fff; margin-bottom: 20px; font-size:1.1rem;" id="final-score">步数: 0</p>
                    <button class="btn-ctrl primary" onclick="nextPuzzle()">挑战下一关</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-ctrl" onclick="startGame()">重置本关</button>
        </div>
    </div>

    <!-- 规则弹窗 -->
    <div class="modal-overlay" id="rulesModal" onclick="toggleRules()">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>游戏规则</h2>
            <p>1. <strong>目标：</strong> 移动棋子，将红色的“曹操”从底部中央的发光出口移出。</p>
            <p>2. <strong>操作：</strong> 
               <br>• 电脑：鼠标<strong>按住并拖拽</strong>棋子。
               <br>• 手机：手指按住滑动。
            </p>
            <p>3. <strong>提示：</strong> 关卡已按难度（步数）排序。</p>
            <div class="modal-footer">
                <span>开发者：ArthurZhu</span>
                <button class="btn-ctrl" style="padding: 6px 20px; font-size: 0.8rem; border-radius: 6px; height: auto;" onclick="toggleRules()">关闭</button>
            </div>
        </div>
    </div>

    <script>
        const ROWS = 5;
        const COLS = 4;
        let containerWidth, unitSize;
        let blocks = []; 
        let stepCount = 0;
        const boardWrapper = document.querySelector('.board-wrapper');
        const boardEl = document.getElementById('board');
        const winMsg = document.getElementById('win-message');
        const stepDisplay = document.getElementById('step-display');
        const puzzleSelect = document.getElementById('puzzle-select');

        const PUZZLES_DATA = [
            { name: "过五关", steps: 37, layout: [{t:'s',x:0,y:0}, {t:'c',x:1,y:0}, {t:'s',x:3,y:0}, {t:'s',x:0,y:1}, {t:'s',x:3,y:1}, {t:'h',x:0,y:2}, {t:'h',x:2,y:2}, {t:'h',x:0,y:3}, {t:'h',x:2,y:3}, {t:'h',x:1,y:4}] },
            { name: "前挡后阻", steps: 44, layout: [{t:'c',x:0,y:0}, {t:'h',x:2,y:0}, {t:'v',x:2,y:1}, {t:'s',x:3,y:1}, {t:'v',x:0,y:2}, {t:'v',x:1,y:2}, {t:'s',x:3,y:2}, {t:'s',x:2,y:3}, {t:'s',x:3,y:3}, {t:'h',x:1,y:4}] },
            { name: "层层设防", steps: 44, layout: [{t:'s',x:0,y:0}, {t:'c',x:1,y:0}, {t:'s',x:3,y:0}, {t:'s',x:0,y:1}, {t:'s',x:3,y:1}, {t:'v',x:0,y:2}, {t:'v',x:1,y:2}, {t:'h',x:2,y:2}, {t:'h',x:2,y:3}, {t:'h',x:1,y:4}] },
            { name: "左右布兵", steps: 62, layout: [{t:'v',x:0,y:0}, {t:'c',x:1,y:0}, {t:'v',x:3,y:0}, {t:'v',x:1,y:2}, {t:'v',x:2,y:2}, {t:'s',x:0,y:3}, {t:'s',x:3,y:3}, {t:'s',x:0,y:4}, {t:'h',x:1,y:4}, {t:'s',x:3,y:4}] },
            { name: "水泄不通", steps: 64, layout: [{t:'c',x:0,y:0}, {t:'h',x:2,y:0}, {t:'h',x:2,y:1}, {t:'v',x:0,y:2}, {t:'v',x:1,y:2}, {t:'h',x:2,y:2}, {t:'s',x:2,y:3}, {t:'s',x:3,y:3}, {t:'s',x:0,y:4}, {t:'s',x:3,y:4}] },
            { name: "兵分三路", steps: 71, layout: [{t:'s',x:0,y:0}, {t:'c',x:1,y:0}, {t:'s',x:3,y:0}, {t:'v',x:0,y:1}, {t:'h',x:1,y:2}, {t:'v',x:3,y:1}, {t:'v',x:0,y:3}, {t:'s',x:1,y:3}, {t:'s',x:2,y:3}, {t:'v',x:3,y:3}] },
            { name: "齐头并前", steps: 74, layout: [{t:'v',x:0,y:0}, {t:'c',x:1,y:0}, {t:'v',x:3,y:0}, {t:'s',x:0,y:2}, {t:'s',x:1,y:2}, {t:'s',x:2,y:2}, {t:'s',x:3,y:2}, {t:'v',x:0,y:3}, {t:'h',x:1,y:3}, {t:'v',x:3,y:3}] },
            { name: "横刀立马", steps: 81, layout: [{t:'v',x:0,y:0}, {t:'c',x:1,y:0}, {t:'v',x:3,y:0}, {t:'v',x:0,y:2}, {t:'h',x:1,y:2}, {t:'v',x:3,y:2}, {t:'s',x:1,y:3}, {t:'s',x:2,y:3}, {t:'s',x:0,y:4}, {t:'s',x:3,y:4}] },
            { name: "插翅难飞", steps: 90, layout: [{t:'v',x:0,y:0}, {t:'c',x:1,y:0}, {t:'v',x:3,y:0}, {t:'s',x:0,y:2}, {t:'v',x:1,y:2}, {t:'s',x:3,y:2}, {t:'s',x:0,y:3}, {t:'s',x:3,y:3}, {t:'h',x:0,y:4}, {t:'h',x:2,y:4}] },
            { name: "横刀立马 II", steps: 90, layout: [{t:'v',x:0,y:0}, {t:'c',x:1,y:0}, {t:'v',x:3,y:0}, {t:'s',x:0,y:2}, {t:'h',x:1,y:2}, {t:'s',x:3,y:2}, {t:'v',x:0,y:3}, {t:'s',x:1,y:3}, {t:'s',x:2,y:3}, {t:'v',x:3,y:3}] },
            { name: "屯兵东路", steps: 102, layout: [{t:'c',x:0,y:0}, {t:'v',x:2,y:0}, {t:'v',x:3,y:0}, {t:'h',x:0,y:2}, {t:'s',x:2,y:2}, {t:'s',x:3,y:2}, {t:'v',x:0,y:3}, {t:'v',x:1,y:3}, {t:'s',x:2,y:3}, {t:'s',x:3,y:3}] },
            { name: "近在咫尺", steps: 117, layout: [{t:'s',x:0,y:0}, {t:'v',x:1,y:0}, {t:'v',x:2,y:0}, {t:'v',x:3,y:0}, {t:'s',x:0,y:1}, {t:'h',x:0,y:2}, {t:'s',x:2,y:2}, {t:'s',x:3,y:2}, {t:'h',x:0,y:3}, {t:'c',x:2,y:3}] },
            { name: "兵挡将阻", steps: 124, layout: [{t:'s',x:0,y:0}, {t:'c',x:1,y:0}, {t:'s',x:3,y:0}, {t:'v',x:0,y:1}, {t:'v',x:3,y:1}, {t:'h',x:1,y:2}, {t:'s',x:0,y:3}, {t:'h',x:1,y:3}, {t:'s',x:3,y:3}, {t:'h',x:1,y:4}] },
            { name: "小燕出巢", steps: 131, layout: [{t:'v',x:0,y:0}, {t:'c',x:1,y:0}, {t:'v',x:3,y:0}, {t:'h',x:0,y:2}, {t:'h',x:2,y:2}, {t:'s',x:0,y:3}, {t:'h',x:1,y:3}, {t:'s',x:3,y:3}, {t:'s',x:0,y:4}, {t:'s',x:3,y:4}] }
        ];

        function init() {
            PUZZLES_DATA.forEach((p, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.innerText = `${index + 1}. ${p.name} (${p.steps}步)`;
                puzzleSelect.appendChild(opt);
            });
            puzzleSelect.selectedIndex = 7; // 横刀立马
            calcDimensions();
            window.addEventListener('resize', () => {
                calcDimensions();
                render();
            });
            startGame();
        }

        function calcDimensions() {
            // 核心修复：使用 wrapper 的宽度，向下取整计算 unitSize
            // 确保 unitSize * 4 永远小于等于 wrapper 宽度
            const wrapperWidth = boardWrapper.getBoundingClientRect().width;
            unitSize = Math.floor(wrapperWidth / COLS);
            
            // 反向设置 boardEl 的宽高，确保它是 unitSize 的整数倍
            boardEl.style.width = (unitSize * COLS) + 'px';
            boardEl.style.height = (unitSize * ROWS) + 'px';
        }

        function startGame() {
            winMsg.style.display = 'none';
            stepCount = 0;
            updateStepDisplay();
            
            const puzzleIndex = parseInt(puzzleSelect.value);
            const layout = PUZZLES_DATA[puzzleIndex].layout;
            
            blocks = layout.map((item, idx) => {
                let type, cls, w, h;
                if (item.t === 'c') { type = '2x2'; cls = 'caocao'; w=2; h=2; }
                else if (item.t === 'v') { type = '1x2'; cls = 'general'; w=1; h=2; }
                else if (item.t === 'h') { type = '2x1'; cls = 'general'; w=2; h=1; }
                else { type = '1x1'; cls = 'soldier'; w=1; h=1; }
                return { id: idx, type, class: cls, x: item.x, y: item.y, w, h };
            });
            
            render();
        }

        function nextPuzzle() {
            if (puzzleSelect.selectedIndex < PUZZLES_DATA.length - 1) {
                puzzleSelect.selectedIndex++;
                startGame();
            } else {
                alert("太厉害了！您已通关所有经典谜题！");
                winMsg.style.display = 'none';
            }
        }

        function updateStepDisplay() {
            stepDisplay.innerText = stepCount.toString().padStart(3, '0');
        }

        function render() {
            const existingBlocks = boardEl.querySelectorAll('.block');
            existingBlocks.forEach(el => el.remove());

            const GAP = 3; 

            blocks.forEach((block, index) => {
                const el = document.createElement('div');
                el.className = `block ${block.class}`;
                
                el.style.width = (block.w * unitSize - GAP * 2) + 'px';
                el.style.height = (block.h * unitSize - GAP * 2) + 'px';
                el.style.left = (block.x * unitSize + GAP) + 'px';
                el.style.top = (block.y * unitSize + GAP) + 'px';
                
                bindInteraction(el, index);
                boardEl.appendChild(el);
            });
        }

        function bindInteraction(el, index) {
            let startX, startY, startTime;
            let isDragging = false;

            const handleStart = (clientX, clientY) => {
                startX = clientX;
                startY = clientY;
                startTime = Date.now();
                isDragging = true;
                el.style.zIndex = 100;
            };

            const handleEnd = (clientX, clientY) => {
                if (!isDragging) return;
                isDragging = false;
                el.style.zIndex = blocks[index].class === 'caocao' ? 15 : 10;

                const dx = clientX - startX;
                const dy = clientY - startY;
                const dt = Date.now() - startTime;

                if (Math.abs(dx) < 10 && Math.abs(dy) < 10 && dt < 300) {
                    tryAutoMove(index); 
                } else {
                    if (Math.abs(dx) > Math.abs(dy)) {
                        moveBlock(index, dx > 0 ? 1 : -1, 0);
                    } else {
                        moveBlock(index, 0, dy > 0 ? 1 : -1);
                    }
                }
            };

            el.addEventListener('mousedown', (e) => { e.preventDefault(); handleStart(e.clientX, e.clientY); });
            const mouseUpHandler = (e) => { if (isDragging) handleEnd(e.clientX, e.clientY); };
            window.addEventListener('mouseup', mouseUpHandler);

            el.addEventListener('touchstart', (e) => { e.preventDefault(); handleStart(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
            el.addEventListener('touchend', (e) => { handleEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY); });
        }

        function tryAutoMove(index) {
            const moves = [{dx:0, dy:-1}, {dx:0, dy:1}, {dx:-1, dy:0}, {dx:1, dy:0}];
            const block = blocks[index];
            const grid = getGrid(index);
            for (let m of moves) {
                if (canMove(block, m.dx, m.dy, grid)) {
                    executeMove(block, m.dx, m.dy);
                    return;
                }
            }
        }

        function moveBlock(index, dx, dy) {
            const block = blocks[index];
            const grid = getGrid(index);
            if (canMove(block, dx, dy, grid)) {
                executeMove(block, dx, dy);
            }
        }

        function executeMove(block, dx, dy) {
            block.x += dx;
            block.y += dy;
            stepCount++;
            updateStepDisplay();
            render();
            checkWin();
        }

        function getGrid(excludeIndex) {
            let grid = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            blocks.forEach((b, i) => {
                if (i !== excludeIndex) {
                    for (let x = 0; x < b.w; x++) {
                        for (let y = 0; y < b.h; y++) {
                            grid[b.y + y][b.x + x] = 1;
                        }
                    }
                }
            });
            return grid;
        }

        function canMove(block, dx, dy, grid) {
            const nx = block.x + dx;
            const ny = block.y + dy;
            if (nx < 0 || nx + block.w > COLS || ny < 0 || ny + block.h > ROWS) return false;
            for (let i = 0; i < block.w; i++) {
                for (let j = 0; j < block.h; j++) {
                    if (grid[ny + j][nx + i] === 1) return false;
                }
            }
            return true;
        }

        function checkWin() {
            const cc = blocks.find(b => b.class === 'caocao');
            if (cc.x === 1 && cc.y === 3) {
                setTimeout(() => {
                    document.getElementById('final-score').innerText = `耗费步数: ${stepCount}`;
                    winMsg.style.display = 'block';
                }, 300);
            }
        }

        function toggleRules() {
            const modal = document.getElementById('rulesModal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        init();
    </script>
</body>
</html>