<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°ç‹¬ï¼ˆby Arthurï¼‰</title>
    <style>
        :root {
            /* --- æµ…è‰²ä¸»é¢˜ --- */
            --bg-body: #f3f5f7; /* æ›´å¹²å‡€çš„ç°ç™½èƒŒæ™¯ */
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-sub: #6b7280;
            
            --board-border: #334155;
            --cell-bg: #ffffff;
            --cell-fixed-text: #0f172a;
            
            --primary-color: #007AFF;
            --primary-hover: #0062cc;
            
            --highlight-rowcol: #f1f5f9; /* ææ·¡ç°è“ */
            --highlight-selected: #bae6fd; /* æ¸…é€è“ */
            
            --error-bg: #fecaca;
            --error-text: #991b1b;
            
            /* æŒ‰é’®è´¨æ„Ÿ */
            --btn-bg: #ffffff;
            --btn-border: #e2e8f0;
            --btn-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
            
            /* åŠŸèƒ½è‰² */
            --undo-bg: #fffbeb; --undo-text: #92400e; --undo-border: #fcd34d;
            --clear-bg: #fef2f2; --clear-text: #b91c1c; --clear-border: #fca5a5;
        }

        [data-theme="dark"] {
            /* --- æ·±è‰²ä¸»é¢˜ --- */
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            
            --board-border: #64748b;
            --cell-bg: #1e293b;
            --cell-fixed-text: #e2e8f0;
            
            --primary-color: #3b82f6;
            --primary-hover: #60a5fa;
            
            --highlight-rowcol: #334155;
            --highlight-selected: #475569;
            
            --error-bg: #7f1d1d;
            --error-text: #fecaca;
            
            --btn-bg: #334155;
            --btn-border: #475569;
            --btn-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            
            --undo-bg: #451a03; --undo-text: #fcd34d; --undo-border: #78350f;
            --clear-bg: #450a0a; --clear-text: #fca5a5; --clear-border: #7f1d1d;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; transition: background-color 0.2s, border-color 0.2s, color 0.2s; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- æ ¸å¿ƒå¸ƒå±€å®¹å™¨ --- */
        /* è¿™ä¸ªå®¹å™¨è´Ÿè´£æŠŠæ‰€æœ‰å†…å®¹èšæ‹¢åœ¨å±å¹•ä¸­é—´ */
        .app-wrapper {
            display: flex;
            flex-direction: column; /* é»˜è®¤ç§»åŠ¨ç«¯å‚ç›´ */
            width: 100%;
            height: 100%;
            max-width: 100%;
            position: relative;
        }

        /* --- 1. å¤´éƒ¨åŒº (Title + Icons) --- */
        .header-row {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            padding: 15px 20px 5px 20px; /* ç§»åŠ¨ç«¯ç•™ç‚¹è¾¹è· */
        }
        
        .game-title {
            font-size: 22px; /* ç§»åŠ¨ç«¯å­—ä½“è°ƒå° */
            font-weight: 800;
            letter-spacing: -0.3px;
            margin-right: 12px;
            color: var(--text-main);
        }

        .icon-group {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 30px; height: 30px;
            border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            background: var(--bg-card);
            box-shadow: var(--btn-shadow);
            border: 1px solid var(--btn-border);
            color: var(--text-main);
        }
        .icon-btn:active { transform: scale(0.92); }
        .icon-btn svg { width: 16px; height: 16px; }

        /* --- 2. è®¾ç½®é¢æ¿ (Settings) --- */
        .settings-panel {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            padding: 12px 16px; /* å¢åŠ å†…è¾¹è·é˜²æ­¢è´´è¾¹ */
            border-radius: 14px;
            box-shadow: var(--btn-shadow);
            margin: 10px 20px; /* å¤–éƒ¨é—´è· */
            flex-shrink: 0;
        }

        .diff-select {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--btn-border);
            background-color: var(--bg-body);
            color: var(--text-main);
            font-size: 14px;
            outline: none;
            appearance: none; /* ç®€å•çš„ä¸‹æ‹‰æ ·å¼ */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 14px;
            padding-right: 30px;
        }

        .btn-start {
            padding: 8px 18px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-start:active { opacity: 0.9; transform: translateY(1px); }

        .timer {
            font-variant-numeric: tabular-nums;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-sub);
            min-width: 50px;
            text-align: right;
        }

        /* --- 3. æ£‹ç›˜åŒº (Board) --- */
        .board-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* ç§»åŠ¨ç«¯é ä¸Šä¸€ç‚¹ */
            padding: 0 20px;
            margin-bottom: 10px;
        }

        .sudoku-board {
            background-color: var(--board-border);
            border: 2px solid var(--board-border);
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 1px;
            border-radius: 6px;
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s;
            /* ç§»åŠ¨ç«¯å¤§å°æ§åˆ¶ */
            width: 100%;
            max-width: 380px; 
            aspect-ratio: 1;
        }
        
        .sudoku-board.inactive { opacity: 0.5; pointer-events: none; filter: grayscale(0.5); }

        .cell {
            background-color: var(--cell-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 500;
            cursor: pointer;
            font-size: 22px; /* ç§»åŠ¨ç«¯é»˜è®¤å­—ä½“ */
        }
        .cell:nth-child(3n) { border-right: 2px solid var(--board-border); }
        .cell:nth-child(9n) { border-right: none; }
        .cell.border-bottom { border-bottom: 2px solid var(--board-border); }

        /* çŠ¶æ€ */
        .cell.highlight { background-color: var(--highlight-rowcol); }
        .cell.selected { background-color: var(--highlight-selected) !important; }
        .cell.fixed { font-weight: 700; color: var(--cell-fixed-text); }
        .cell.user-input { color: var(--primary-color); font-weight: 600; }
        .cell.conflict { background-color: var(--error-bg) !important; color: var(--error-text) !important; }

        /* --- 4. é”®ç›˜ä¸æ§åˆ¶åŒº --- */
        .controls-wrapper {
            padding: 0 20px 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
        }

        /* é”®ç›˜ */
        .numpad {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }
        
        .num-btn {
            background-color: var(--bg-card);
            color: var(--primary-color);
            border: 1px solid var(--btn-border);
            border-radius: 10px;
            font-size: 20px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: var(--btn-shadow);
            transition: all 0.1s;
            display: flex; justify-content: center; align-items: center;
            /* ç§»åŠ¨ç«¯å¤§å°: ä¸€è¡Œ5ä¸ª */
            width: calc(20% - 7px);
            aspect-ratio: 1.1;
        }
        .num-btn:active { transform: scale(0.95); background-color: var(--highlight-rowcol); }

        /* å·¥å…· */
        .tools-row {
            display: flex;
            gap: 12px;
        }

        .tool-btn {
            flex: 1;
            height: 46px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .tool-btn:active { transform: scale(0.98); opacity: 0.9; }

        .btn-undo { background: var(--undo-bg); color: var(--undo-text); border: 1px solid var(--undo-border); }
        .btn-clear { background: var(--clear-bg); color: var(--clear-text); border: 1px solid var(--clear-border); }


        /* =========================================
           PC ç«¯ä¼˜é›…é€‚é… (Desktop Layout)
           ========================================= */
        @media (min-width: 800px) {
            /* ä¸»å®¹å™¨è½¬ä¸ºå±…ä¸­å¯¹é½ */
            .app-wrapper {
                flex-direction: row;
                justify-content: center;
                align-items: center; /* å‚ç›´å±…ä¸­ï¼Œè§†è§‰èšåˆ */
                padding: 0;
                gap: 40px; /* æ ¸å¿ƒï¼šæ‹‰è¿‘å·¦å³é—´è· */
                max-width: 1100px; /* é™åˆ¶æ•´ä½“æœ€å¤§å®½åº¦ï¼Œæ›´èšæ°” */
                height: auto; /* é«˜åº¦ç”±å†…å®¹æ’‘å¼€ï¼Œä½†ä¸è¦è¶…è¿‡å±å¹• */
                max-height: 95vh;
            }

            /* å·¦ä¾§ï¼šæ ‡é¢˜ + æ£‹ç›˜ */
            /* åˆ›å»ºä¸€ä¸ªé€»è¾‘å®¹å™¨åŒ…ä½å®ƒä»¬ */
            .left-section {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .header-row {
                padding: 0;
                margin-bottom: 5px;
            }
            .game-title { 
                font-size: 28px; /* PCç«¯å­—ä½“é€‚ä¸­ï¼Œä¸è¦å¤ªå¤§ */
                margin-right: 15px;
            }
            .icon-btn { width: 32px; height: 32px; }

            .board-container {
                padding: 0;
                margin: 0;
                display: block; /* è®©æ£‹ç›˜å¤§å°ç”±è‡ªèº«å†³å®š */
                flex: none;
            }

            .sudoku-board {
                /* æ ¸å¿ƒï¼šæ§åˆ¶PCç«¯æ£‹ç›˜å¤§å°ï¼Œæ—¢è¦å¤§åˆä¸èƒ½å‚»å¤§ */
                width: 560px; 
                height: 560px;
                /* å“åº”å¼ä¿åº•ï¼šå¦‚æœå±å¹•é«˜åº¦å¾ˆå°(å¦‚ç¬”è®°æœ¬)ï¼Œåˆ™ç­‰æ¯”ç¼©å° */
                max-height: 75vh;
                max-width: 75vh;
            }
            .cell { font-size: 28px; }

            /* å³ä¾§ï¼šæ§åˆ¶é¢æ¿ */
            /* ä»ç§»åŠ¨ç«¯çš„ä¸Šä¸‹åˆ†å¸ƒæ”¹ä¸ºå³ä¾§å‚ç›´åˆ†å¸ƒ */
            .right-section {
                display: flex;
                flex-direction: column;
                width: 280px; /* ç²¾è‡´çš„å®½åº¦ */
                gap: 25px;
                /* ç¨å¾®å‘ä¸‹åç§»ä¸€ç‚¹ï¼Œå’Œæ£‹ç›˜è§†è§‰é‡å¿ƒå¯¹é½ */
                padding-top: 50px; 
            }

            /* åœ¨PCç«¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ settings-panel å’Œ controls-wrapper æŒªåˆ° right-section */
            /* é€šè¿‡ DOM ç»“æ„è°ƒæ•´æˆ– CSS æŠ€å·§ã€‚è¿™é‡Œæˆ‘ä»¬ç”¨ JS è°ƒæ•´ç»“æ„ï¼Œæˆ–è€…ç›´æ¥ç”¨ä¸¤å¥— DOM (ä¸æ¨è)ã€‚
               ä¸ºäº†æœ€ä¼˜é›…çš„ä»£ç ï¼Œæˆ‘ä»¬ä¾èµ–ä¸‹æ–¹çš„ responsiveLayout JS å‡½æ•°æ¥ç§»åŠ¨ DOM èŠ‚ç‚¹ã€‚
            */

            .settings-panel {
                flex-direction: column;
                align-items: stretch;
                margin: 0;
                padding: 20px;
                gap: 15px;
                background: var(--bg-card);
                border: 1px solid var(--btn-border); /* å¢åŠ ä¸€ç‚¹è¾¹æ¡†è´¨æ„Ÿ */
            }
            .timer { text-align: center; font-size: 22px; margin-top: 5px; }
            .btn-start { height: 44px; font-size: 16px; }
            .diff-select { padding: 10px; }

            .controls-wrapper {
                padding: 0;
                gap: 20px;
            }

            .numpad {
                /* PCç«¯æ”¹ä¸ºä¹å®«æ ¼ */
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            .num-btn {
                width: auto;
                aspect-ratio: 1.2;
                font-size: 24px;
            }
            
            .tools-row { gap: 15px; }
            .tool-btn { height: 50px; }
        }

        /* å¼¹çª—ä¼˜åŒ– */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(3px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: var(--bg-card);
            color: var(--text-main);
            width: 320px;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            transform: scale(0.95); transition: transform 0.2s;
        }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal h2 { margin-top: 0; text-align: center; font-size: 20px; margin-bottom: 15px; }
        .modal ul { padding-left: 20px; line-height: 1.6; font-size: 14px; color: var(--text-sub); margin-bottom: 20px; }
        .modal-btn {
            width: 100%; padding: 10px; background: var(--text-main); color: var(--bg-card);
            border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
        }
        .credit { text-align: center; font-size: 12px; color: var(--text-sub); margin-top: 15px; border-top: 1px solid var(--btn-border); padding-top: 10px;}

    </style>
</head>
<body>

    <div class="app-wrapper">
        
        <!-- é€»è¾‘å®¹å™¨ 1ï¼šå·¦ä¾§ (PC) / ä¸Šéƒ¨ (Mobile) -->
        <div class="left-section">
            <!-- å¤´éƒ¨ -->
            <div class="header-row">
                <div class="game-title">æ•°ç‹¬ï¼ˆby Arthurï¼‰</div>
                <div class="icon-group">
                    <div class="icon-btn" id="btn-rules" title="è§„åˆ™">
                        <span style="font-weight:800; font-size:14px;">?</span>
                    </div>
                    <div class="icon-btn" id="btn-theme" title="å¤œé—´æ¨¡å¼">
                        <!-- Sun -->
                        <svg class="icon-sun" style="display:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <!-- Moon -->
                        <svg class="icon-moon" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </div>
                </div>
            </div>

            <!-- æ£‹ç›˜ -->
            <div class="board-container">
                <div class="sudoku-board inactive" id="board">
                    <!-- JS Gen -->
                </div>
            </div>
        </div>

        <!-- é€»è¾‘å®¹å™¨ 2ï¼šå³ä¾§ (PC) / ä¸‹éƒ¨ (Mobile) -->
        <div class="right-section">
            <!-- è®¾ç½®æ  -->
            <div class="settings-panel">
                <select id="difficulty-select" class="diff-select">
                    <option value="1">å…¥é—¨ (Easy)</option>
                    <option value="2">åˆçº§ (Medium)</option>
                    <option value="3" selected>ä¸­çº§ (Hard)</option>
                    <option value="4">é«˜çº§ (Expert)</option>
                    <option value="5">åœ°ç‹± (Hell)</option>
                </select>
                <button class="btn-start" onclick="startNewGame()">å¼€å§‹æ¸¸æˆ</button>
                <div class="timer" id="timer">00:00</div>
            </div>

            <!-- é”®ç›˜ä¸å·¥å…· -->
            <div class="controls-wrapper">
                <div class="numpad">
                    <button class="num-btn" onclick="inputNumber(1)">1</button>
                    <button class="num-btn" onclick="inputNumber(2)">2</button>
                    <button class="num-btn" onclick="inputNumber(3)">3</button>
                    <button class="num-btn" onclick="inputNumber(4)">4</button>
                    <button class="num-btn" onclick="inputNumber(5)">5</button>
                    <button class="num-btn" onclick="inputNumber(6)">6</button>
                    <button class="num-btn" onclick="inputNumber(7)">7</button>
                    <button class="num-btn" onclick="inputNumber(8)">8</button>
                    <button class="num-btn" onclick="inputNumber(9)">9</button>
                </div>
                <div class="tools-row">
                    <button class="tool-btn btn-undo" id="btn-undo">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>
                        æ’¤é”€
                    </button>
                    <button class="tool-btn btn-clear" onclick="inputNumber(0)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        æ¸…é™¤
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- å¼¹çª—åŒº -->
    <div class="modal-overlay" id="rules-modal">
        <div class="modal">
            <h2>æ¸¸æˆè§„åˆ™</h2>
            <ul>
                <li><strong>æµç¨‹ï¼š</strong>é€‰æ‹©éš¾åº¦ï¼Œç‚¹å‡»ã€å¼€å§‹æ¸¸æˆã€‘ã€‚</li>
                <li><strong>ç›®æ ‡ï¼š</strong>åœ¨9x9ç½‘æ ¼ä¸­å¡«å…¥1-9ã€‚</li>
                <li><strong>è§„åˆ™ï¼š</strong>æ¯è¡Œã€æ¯åˆ—åŠæ¯å®«å†…æ•°å­—ä¸é‡å¤ã€‚</li>
                <li><strong>å†²çªï¼š</strong>è¿åè§„åˆ™æ—¶æ ¼å­ä¼šå˜çº¢ã€‚</li>
            </ul>
            <div class="credit">å¼€å‘è€…ï¼šArthurZhu</div>
            <button class="modal-btn" onclick="closeModal('rules-modal')">æ˜ç™½</button>
        </div>
    </div>

    <div class="modal-overlay" id="win-modal">
        <div class="modal">
            <h2 style="color: var(--primary-color);">ğŸ‰ æŒ‘æˆ˜æˆåŠŸï¼</h2>
            <p style="text-align:center;">
                éš¾åº¦ï¼š<span id="win-diff" style="font-weight:bold"></span><br><br>
                è€—æ—¶ï¼š<span id="win-time" style="font-weight:bold; font-size:22px; color:var(--text-main);"></span>
            </p>
            <button class="modal-btn" onclick="closeWinModal()">å†ç©ä¸€å±€</button>
        </div>
    </div>

    <!-- å¸ƒå±€è‡ªé€‚åº”è„šæœ¬ -->
    <script>
        // åŠ¨æ€è°ƒæ•´ DOM ç»“æ„ä»¥é€‚åº” PC/Mobile ä¸åŒçš„é€»è¾‘åˆ†ç»„
        // Mobile: Title -> Settings -> Board -> Controls
        // PC: Left(Title, Board) | Right(Settings, Controls)
        function layoutManager() {
            const isDesktop = window.innerWidth >= 800;
            const leftSection = document.querySelector('.left-section');
            const rightSection = document.querySelector('.right-section');
            
            const settingsPanel = document.querySelector('.settings-panel');
            const boardContainer = document.querySelector('.board-container');
            
            if (isDesktop) {
                // PC: Settings ç§»åŠ¨åˆ° Right Section é¡¶éƒ¨
                if (rightSection.firstChild !== settingsPanel) {
                    rightSection.insertBefore(settingsPanel, rightSection.firstChild);
                }
            } else {
                // Mobile: Settings ç§»åŠ¨åˆ° Left Section çš„ Board ä¹‹å‰
                if (boardContainer.previousElementSibling !== settingsPanel) {
                    leftSection.insertBefore(settingsPanel, boardContainer);
                }
            }
        }
        window.addEventListener('resize', layoutManager);
        document.addEventListener('DOMContentLoaded', layoutManager);
    </script>

    <script>
        /* --- Theme --- */
        const btnTheme = document.getElementById('btn-theme');
        const iconSun = document.querySelector('.icon-sun');
        const iconMoon = document.querySelector('.icon-moon');
        let isDark = false;
        btnTheme.addEventListener('click', () => {
            isDark = !isDark;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            iconSun.style.display = isDark ? 'none' : 'block';
            iconMoon.style.display = isDark ? 'block' : 'none';
        });

        /* --- Logic --- */
        let solutionBoard = [], initialBoard = [], currentBoard = [];
        let selectedIndex = -1, historyMoves = [], timerInterval = null, startTime = 0, isGameActive = false;
        const boardEl = document.getElementById('board');
        const timerEl = document.getElementById('timer');

        window.onload = () => { createGrid(); layoutManager(); };

        function createGrid() {
            boardEl.innerHTML = '';
            for(let i=0; i<81; i++) {
                let cell = document.createElement('div');
                cell.className = 'cell';
                const row = Math.floor(i/9);
                if(row === 2 || row === 5) cell.classList.add('border-bottom');
                cell.onclick = () => selectCell(i);
                boardEl.appendChild(cell);
            }
        }

        function startNewGame() {
            const diff = parseInt(document.getElementById('difficulty-select').value);
            const solved = generateSolved();
            initialBoard = punchHoles(solved, diff);
            currentBoard = [...initialBoard];
            historyMoves = [];
            selectedIndex = -1;
            isGameActive = true;
            boardEl.classList.remove('inactive');
            renderBoard();
            startTimer();
        }

        function renderBoard() {
            const cells = boardEl.children;
            const conflicts = getConflicts(currentBoard);
            const sRow = selectedIndex !== -1 ? Math.floor(selectedIndex/9) : -1;
            const sCol = selectedIndex !== -1 ? selectedIndex%9 : -1;

            for(let i=0; i<81; i++) {
                const val = currentBoard[i];
                const cell = cells[i];
                const row = Math.floor(i/9);
                const col = i%9;
                
                let cls = ['cell'];
                if(row === 2 || row === 5) cls.push('border-bottom');
                cell.textContent = val === 0 ? '' : val;
                if(initialBoard[i] !== 0) cls.push('fixed');
                else if(val !== 0) cls.push('user-input');

                if(selectedIndex !== -1) {
                    if(i === selectedIndex) cls.push('selected');
                    else if(row === sRow || col === sCol) cls.push('highlight');
                }
                if(val !== 0 && conflicts.has(i)) cls.push('conflict');
                cell.className = cls.join(' ');
            }
        }

        function selectCell(index) {
            if(!isGameActive) return;
            selectedIndex = index;
            renderBoard();
        }

        function inputNumber(num) {
            if(!isGameActive || selectedIndex === -1) return;
            if(initialBoard[selectedIndex] !== 0) return;
            historyMoves.push([...currentBoard]);
            currentBoard[selectedIndex] = num;
            renderBoard();
            checkWin();
        }

        function generateSolved() {
            let board = Array(81).fill(0);
            solve(board);
            return board;
        }
        function solve(board) {
            for(let i=0; i<81; i++) {
                if(board[i]===0) {
                    let nums = [1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
                    for(let n of nums) {
                        if(isValid(board, i, n)) {
                            board[i]=n;
                            if(solve(board)) return true;
                            board[i]=0;
                        }
                    }
                    return false;
                }
            }
            return true;
        }
        function isValid(board, idx, num) {
            const r=Math.floor(idx/9), c=idx%9;
            const br=Math.floor(r/3)*3, bc=Math.floor(c/3)*3;
            for(let k=0; k<9; k++) {
                if(board[r*9+k]===num) return false;
                if(board[k*9+c]===num) return false;
                if(board[(br+Math.floor(k/3))*9+(bc+k%3)]===num) return false;
            }
            return true;
        }
        function punchHoles(solved, diff) {
            let board = [...solved];
            let holes = [30,38,46,52,58][diff-1] || 30;
            let attempts = holes;
            while(attempts>0) {
                let idx = Math.floor(Math.random()*81);
                if(board[idx]!==0) { board[idx]=0; attempts--; }
            }
            return board;
        }
        function getConflicts(board) {
            let set = new Set();
            const add = (a,b) => { set.add(a); set.add(b); };
            for(let i=0; i<9; i++) {
                let rS={}, cS={}, bS={};
                for(let j=0; j<9; j++) {
                    let rI=i*9+j; if(board[rI]) { if(rS[board[rI]]!=undefined) add(rI, rS[board[rI]]); else rS[board[rI]]=rI; }
                    let cI=j*9+i; if(board[cI]) { if(cS[board[cI]]!=undefined) add(cI, cS[board[cI]]); else cS[board[cI]]=cI; }
                    let br=Math.floor(i/3)*3+Math.floor(j/3), bc=(i%3)*3+(j%3);
                    let bI=br*9+bc; if(board[bI]) { if(bS[board[bI]]!=undefined) add(bI, bS[board[bI]]); else bS[board[bI]]=bI; }
                }
            }
            return set;
        }
        function checkWin() {
            if(currentBoard.includes(0)) return;
            if(getConflicts(currentBoard).size===0) {
                isGameActive=false; clearInterval(timerInterval);
                document.getElementById('win-diff').innerText = document.getElementById('difficulty-select').selectedOptions[0].text;
                document.getElementById('win-time').innerText = timerEl.innerText;
                document.getElementById('win-modal').classList.add('active');
            }
        }

        document.getElementById('btn-undo').onclick = () => { if(isGameActive && historyMoves.length) { currentBoard=historyMoves.pop(); renderBoard(); }};
        document.getElementById('btn-rules').onclick = () => document.getElementById('rules-modal').classList.add('active');
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function closeWinModal() { closeModal('win-modal'); isGameActive=false; boardEl.classList.add('inactive'); timerEl.innerText="00:00"; createGrid(); }
        function startTimer() {
            clearInterval(timerInterval); startTime=Date.now(); timerEl.innerText="00:00";
            timerInterval = setInterval(() => {
                let d=Math.floor((Date.now()-startTime)/1000);
                timerEl.innerText = `${String(Math.floor(d/60)).padStart(2,'0')}:${String(d%60).padStart(2,'0')}`;
            }, 1000);
        }
        document.addEventListener('keydown', (e) => {
            if(!isGameActive) return;
            if(e.key>='1' && e.key<='9') inputNumber(parseInt(e.key));
            if(e.key==='Backspace'||e.key==='Delete'||e.key==='0') inputNumber(0);
            if(selectedIndex!==-1) {
                if(e.key==='ArrowUp' && selectedIndex>=9) selectCell(selectedIndex-9);
                else if(e.key==='ArrowDown' && selectedIndex<72) selectCell(selectedIndex+9);
                else if(e.key==='ArrowLeft' && selectedIndex%9!==0) selectCell(selectedIndex-1);
                else if(e.key==='ArrowRight' && selectedIndex%9!==8) selectCell(selectedIndex+1);
            }
        });
    </script>
</body>
</html>