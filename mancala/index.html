<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>宝石棋（by Arthur）</title>
    <style>
        :root {
            /* --- 1. 背景优化：更透亮的聚光灯红绒布 --- */
            --bg-color: #2b0202;
            /* 中心更亮，模拟强光打在红布上 */
            --bg-gradient: radial-gradient(circle at 50% 30%, #a31e2d 0%, #6e101c 40%, #2b0202 100%);
            
            /* 棋盘：光面黑胡桃木 */
            --wood-gradient: linear-gradient(160deg, #5d4037 0%, #3e2723 100%);
            --wood-border: #281812;
            
            /* 坑位 */
            --pit-bg: #2d1b15;
            --pit-shadow: inset 3px 3px 8px rgba(0,0,0,0.8), inset -1px -1px 3px rgba(255,255,255,0.08);
            
            /* 字体 */
            --text-gold: #ffecb3; 
            --text-engraved: #120a08;
            
            /* 宝石 */
            --gem-ruby: rgba(220, 20, 60, 0.95);
            --gem-sapphire: rgba(30, 144, 255, 0.95);
            --gem-emerald: rgba(46, 204, 113, 0.95);
            --gem-topaz: rgba(255, 215, 0, 0.95);
            --gem-amethyst: rgba(155, 89, 182, 0.95);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            background-image: var(--bg-gradient);
            margin: 0;
            min-height: 100vh;
            /* 关键：启用Flex列布局，允许自然滚动 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* 从顶部开始排列 */
            overflow-y: auto; /* 允许垂直滚动 */
            padding-bottom: 40px; /* 底部留白 */
        }

        /* 绒布纹理 */
        body::before {
            content: "";
            position: fixed; /* 固定背景纹理 */
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.06'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
            mix-blend-mode: overlay;
        }

        /* --- 2. 顶部栏重构 (HUD Layout) --- */
        .top-hud-container {
            width: 100%;
            max-width: 980px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 10px;
            z-index: 20;
            position: relative;
        }

        .header-title {
            margin: 0 0 15px 0;
            font-size: 1.8rem;
            font-weight: 900;
            letter-spacing: 1px;
            color: #fff;
            text-shadow: 0 2px 0 #b8860b, 0 5px 10px rgba(0,0,0,0.8);
            background: linear-gradient(to bottom, #fff, #ffecb3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            -webkit-text-stroke: 0.5px rgba(0,0,0,0.3);
            text-align: center;
        }

        .turn-pill {
            padding: 8px 30px;
            border-radius: 20px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 236, 179, 0.4);
            color: #fff;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            margin-bottom: 10px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .icon-btn {
            position: absolute; /* 帮助按钮固定在右上角 */
            right: 20px;
            top: 20px;
            width: 38px; height: 38px; border-radius: 50%;
            border: 2px solid #ffecb3; background: rgba(0,0,0,0.3);
            color: #fff; font-size: 1.2rem; font-weight: 900;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* --- 横屏手机优化 (Landscape Mobile) --- */
        @media (max-height: 600px) and (orientation: landscape) {
            .top-hud-container {
                flex-direction: row; /* 改为横向排列 */
                justify-content: center;
                align-items: center;
                gap: 20px;
                padding: 10px 20px;
            }
            .header-title {
                margin: 0;
                font-size: 1.4rem;
            }
            .turn-pill {
                margin: 0;
                padding: 5px 20px;
                font-size: 0.9rem;
            }
            .icon-btn {
                position: static; /* 取消绝对定位，加入流 */
                width: 32px; height: 32px; font-size: 1rem;
            }
        }

        /* --- 棋盘主体 --- */
        .game-container {
            width: 95vw; 
            max-width: 980px; 
            /* 桌面端保持比例 */
            aspect-ratio: 2.5 / 1;
            position: relative; 
            z-index: 2;
            flex-shrink: 0; /* 防止被挤压 */
        }

        .wood-board {
            width: 100%; height: 100%; border-radius: 50px;
            background: var(--wood-gradient);
            border: 8px solid var(--wood-border);
            box-shadow: inset 0 0 40px rgba(0,0,0,0.8), inset 1px 1px 2px rgba(255,255,255,0.15), 0 20px 50px rgba(0,0,0,0.6);
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.5% 3%; position: relative;
        }

        /* 大本营 */
        .store {
            width: 13%; height: 88%;
            background-color: var(--pit-bg);
            border-radius: 30px;
            box-shadow: var(--pit-shadow);
            position: relative; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .store-tag {
            position: absolute; top: 15px;
            font-size: 0.75rem; font-weight: 700; color: #aaa;
            background: rgba(0,0,0,0.4); padding: 4px 8px;
            border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);
            pointer-events: none;
        }

        .store-label {
            font-size: 2.8rem; font-weight: 900; color: var(--text-engraved);
            text-shadow: 0px -1px 1px rgba(0,0,0,0.5), 0px 1px 1px rgba(255,255,255,0.2);
            z-index: 20; pointer-events: none; margin-top: 25px;
        }

        /* 坑位区域 */
        .rows-area {
            flex: 1; height: 88%;
            display: flex; flex-direction: column; justify-content: space-between;
            margin: 0 2%;
        }

        .row { display: flex; justify-content: space-between; height: 45%; }

        .pit-wrapper {
            width: 15%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }

        .pit {
            width: 88%; aspect-ratio: 1; border-radius: 50%;
            background-color: var(--pit-bg);
            box-shadow: var(--pit-shadow);
            position: relative; cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.1s;
        }
        .pit:active { transform: scale(0.95); }
        
        .active-turn {
            box-shadow: inset 0 0 15px rgba(255, 215, 0, 0.2), 0 0 15px rgba(255, 215, 0, 0.4);
            border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .seed-count {
            position: absolute; bottom: -25px;
            font-size: 1rem; font-weight: 800; color: #2d1b15;
            text-shadow: 0px 1px 0px rgba(255,255,255,0.3);
        }

        /* 宝石 */
        .gem {
            position: absolute; width: 19px; height: 19px; border-radius: 50%;
            z-index: 10; pointer-events: none;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,1) 0%, var(--gem-color) 50%, rgba(0,0,0,0.8) 100%);
            box-shadow: 2px 3px 5px rgba(0,0,0,0.6), inset -1px -1px 3px rgba(0,0,0,0.4), inset 2px 2px 3px rgba(255,255,255,0.9);
        }
        .flying-gem {
            position: fixed; z-index: 9999; width: 26px; height: 26px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,1) 0%, var(--gem-color) 60%, rgba(0,0,0,0.5) 100%);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.6);
            pointer-events: none; opacity: 1 !important;
            transition: top 0.4s cubic-bezier(0.25, 1, 0.5, 1), left 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* --- 3. 竖屏/手机适配深度优化 (Portrait Mobile) --- */
        @media (max-width: 600px) and (orientation: portrait) {
            /* 标题栏保持紧凑 */
            .top-hud-container {
                padding: 15px;
                margin-bottom: 0;
            }
            .header-title { font-size: 1.6rem; }

            /* 容器：允许无限增高，不设固定视口高度 */
            .game-container {
                width: 92vw;
                height: auto; /* 允许内容撑开 */
                aspect-ratio: unset;
                margin-bottom: 80px; /* 给底部退出按钮留位置 */
            }

            .wood-board {
                flex-direction: column;
                padding: 20px;
                border-width: 6px;
                /* 强制最小高度，确保不挤压。800px足够让棋坑舒展开 */
                min-height: 850px; 
            }

            /* 大本营：固定高度，不随flex伸缩 */
            #pit-13, #pit-6 {
                order: 1;
                width: 60%;
                height: 80px; /* 固定高度 */
                flex-shrink: 0;
                border-radius: 15px;
                margin: 10px 0;
            }
            #pit-6 { order: 3; }

            .store-tag { top: 5px; font-size: 0.6rem; padding: 2px 6px; }
            .store-label { margin-top: 10px; font-size: 2rem; }

            /* 中间区域：自由伸缩 */
            .rows-area {
                order: 2;
                width: 100%;
                flex-grow: 1; /* 占满剩余空间 */
                flex-direction: row;
                justify-content: space-between;
                margin: 20px 0;
                gap: 20px; /* 左右列间距 */
            }

            .row {
                width: 45%;
                height: 100%;
                flex-direction: column;
                justify-content: space-between; /* 均匀分布 */
            }
            
            .rows-area .row:first-child { order: 1; } 
            .rows-area .row:last-child { order: 2; flex-direction: column-reverse; } 

            /* 坑位容器 */
            .pit-wrapper {
                width: 100%;
                height: auto; /* 不限制高度 */
                flex-grow: 1;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            /* 棋坑：大尺寸，固定宽高比例 */
            .pit {
                width: 17vw; /* 使用视窗宽度比例，确保大屏小屏都合适 */
                height: 17vw; /* 正圆 */
                max-width: 85px; max-height: 85px;
                margin: 10px 0; /* 确保垂直间距 */
            }

            /* 数字放在两侧，不挡路 */
            .seed-count {
                bottom: auto; top: 50%; transform: translateY(-50%);
                font-size: 1.1rem;
            }
            .rows-area .row:first-child .seed-count { right: auto; left: -12px; }
            .rows-area .row:last-child .seed-count { left: auto; right: -12px; }
        }

        /* 退出按钮样式 */
        .exit-btn-container {
            /* 如果页面长，就放在流的底部；如果短，可以用margin控制 */
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 20px 0;
        }

        /* --- 菜单与UI --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }

        .panel {
            background: linear-gradient(145deg, #2b1d18, #1a100c);
            padding: 30px; border-radius: 16px; width: 85%; max-width: 450px;
            text-align: center; box-shadow: 0 25px 60px rgba(0,0,0,0.9);
            border: 2px solid #5d4037;
        }
        .panel h2, .panel h3 { color: #ffecb3; margin-top: 0; font-weight: 800; border-bottom: 1px solid #5d4037; padding-bottom: 15px; }
        .panel p, .panel li { text-align: left; color: #ddd; line-height: 1.6; font-size: 0.95rem; }
        
        .menu-btn {
            width: 100%; padding: 14px; margin-bottom: 15px; border: none; border-radius: 6px;
            background: linear-gradient(to bottom, #e6c15c, #c29626);
            color: #2b0202; font-weight: 800; font-size: 1.1rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .menu-btn.secondary { background: transparent; border: 2px solid #666; color: #bbb; box-shadow: none; }
        .dev-credit { margin-top: 20px; font-size: 0.85rem; color: #777; text-align: right; font-weight: bold; font-style: italic; }
    </style>
</head>
<body>

    <!-- 顶部栏 (HUD) -->
    <div class="top-hud-container">
        <h1 class="header-title">宝石棋（by Arthur）</h1>
        <div id="turn-msg" class="turn-pill">红方回合</div>
        <button class="icon-btn" onclick="showRules()">?</button>
    </div>

    <!-- 游戏棋盘 -->
    <div class="game-container">
        <div class="wood-board">
            <!-- 蓝方大本营 -->
            <div class="store" id="pit-13">
                <div class="store-tag">对方大本营</div>
                <div class="store-label">0</div>
            </div>

            <div class="rows-area">
                <!-- 蓝方 -->
                <div class="row">
                    <div class="pit-wrapper"><div class="pit" id="pit-12" onclick="clickPit(12)"></div><span class="seed-count">4</span></div>
                    <div class="pit-wrapper"><div class="pit" id="pit-11" onclick="clickPit(11)"></div><span class="seed-count">4</span></div>
                    <div class="pit-wrapper"><div class="pit" id="pit-10" onclick="clickPit(10)"></div><span class="seed-count">4</span></div>
                    <div class="pit-wrapper"><div class="pit" id="pit-9" onclick="clickPit(9)"></div><span class="seed-count">4</span></div>
                    <div class="pit-wrapper"><div class="pit" id="pit-8" onclick="clickPit(8)"></div><span class="seed-count">4</span></div>
                    <div class="pit-wrapper"><div class="pit" id="pit-7" onclick="clickPit(7)"></div><span class="seed-count">4</span></div>
                </div>
                
                <!-- 红方 -->
                <div class="row">
                    <div class="pit-wrapper"><div class="pit" id="pit-0" onclick="clickPit(0)"></div><span class="seed-count">4</span></div>
                    <div class="pit-wrapper"><div class="pit" id="pit-1" onclick="clickPit(1)"></div><span class="seed-count">4</span></div>
                    <div class="pit-wrapper"><div class="pit" id="pit-2" onclick="clickPit(2)"></div><span class="seed-count">4</span></div>
                    <div class="pit-wrapper"><div class="pit" id="pit-3" onclick="clickPit(3)"></div><span class="seed-count">4</span></div>
                    <div class="pit-wrapper"><div class="pit" id="pit-4" onclick="clickPit(4)"></div><span class="seed-count">4</span></div>
                    <div class="pit-wrapper"><div class="pit" id="pit-5" onclick="clickPit(5)"></div><span class="seed-count">4</span></div>
                </div>
            </div>

            <!-- 红方大本营 -->
            <div class="store" id="pit-6">
                <div class="store-tag">我方大本营</div>
                <div class="store-label">0</div>
            </div>
        </div>
    </div>

    <div class="exit-btn-container">
        <button class="menu-btn secondary" style="width:auto; padding: 10px 40px;" onclick="showMainMenu()">退出</button>
    </div>

    <!-- 菜单 -->
    <div class="modal-overlay show" id="setup-modal">
        <div class="panel">
            <h2>新对局</h2>
            <div id="mode-select">
                <button class="menu-btn" onclick="selectMode('pve')">人机对战 (PVE)</button>
                <button class="menu-btn" onclick="selectMode('pvp')">双人对战 (PVP)</button>
            </div>
            <div id="diff-select" style="display:none;">
                <p style="text-align:center; margin-bottom:20px; color:#ffecb3; font-weight:bold;">选择对手强度</p>
                <button class="menu-btn" onclick="startGame('easy')">萌新 (Easy)</button>
                <button class="menu-btn" onclick="startGame('medium')">熟练 (Medium)</button>
                <button class="menu-btn" onclick="startGame('hard')">大师 (Hard)</button>
                <button class="menu-btn secondary" onclick="backToMode()">返回</button>
            </div>
        </div>
    </div>

    <!-- 规则 -->
    <div class="modal-overlay" id="rules-modal">
        <div class="panel">
            <h3>游戏规则</h3>
            <ul>
                <li><strong>目标：</strong> 结束时，己方大本营（长槽）内的宝石更多者获胜。</li>
                <li><strong>播种：</strong> 点击己方小坑，取出宝石，逆时针逐个放入后续坑中。</li>
                <li><strong>奖励：</strong> 若最后一颗落入己方大本营，可再走一步。</li>
                <li><strong>捕获：</strong> 若最后一颗落入己方空坑且对面有子，则通吃。</li>
            </ul>
            <div class="dev-credit">开发者：ArthurZhu</div>
            <div style="margin-top:20px; font-size:0.8rem; color:#666; text-align:center;">(点击空白处关闭)</div>
        </div>
    </div>

    <script>
        const GEM_COLORS = ['var(--gem-ruby)', 'var(--gem-sapphire)', 'var(--gem-emerald)', 'var(--gem-topaz)', 'var(--gem-amethyst)'];
        const INITIAL_SEEDS = 4;
        
        let board = [];
        let currentPlayer = 0; 
        let gameMode = 'pvp';
        let aiLevel = 'easy';
        let isGameActive = false;
        let isAnimating = false;

        function initGame() {
            board = Array(14).fill(INITIAL_SEEDS);
            board[6] = 0; board[13] = 0;
            currentPlayer = 0;
            isGameActive = true;
            isAnimating = false;
            renderBoardFull();
            updateTurnMsg();
        }

        function renderBoardFull() {
            for(let i=0; i<14; i++) {
                const pitEl = document.getElementById(`pit-${i}`);
                const oldGems = pitEl.querySelectorAll('.gem');
                oldGems.forEach(g => g.remove());
                
                updatePitNumber(i, board[i]);

                if(board[i] > 0) {
                    const frag = document.createDocumentFragment();
                    let visualCount = (i===6||i===13) ? Math.min(board[i], 24) : board[i];
                    for(let k=0; k<visualCount; k++) {
                        frag.appendChild(createStaticGem(i));
                    }
                    pitEl.appendChild(frag);
                }
            }
            highlightActivePits();
        }

        function createStaticGem(pitIndex) {
            const gem = document.createElement('div');
            const colorVar = GEM_COLORS[Math.floor(Math.random() * GEM_COLORS.length)];
            gem.className = 'gem';
            gem.style.setProperty('--gem-color', colorVar);
            
            const isStore = (pitIndex === 6 || pitIndex === 13);
            let min = 15, max = 70;
            if (isStore) { min = 10; max = 80; }
            
            const left = Math.floor(Math.random() * (max - min + 1)) + min;
            const top = Math.floor(Math.random() * (max - min + 1)) + min;
            const rot = Math.floor(Math.random() * 360);
            
            gem.style.left = `${left}%`;
            gem.style.top = `${top}%`;
            gem.style.transform = `rotate(${rot}deg)`;
            return gem;
        }

        function updatePitNumber(index, count) {
            const pitEl = document.getElementById(`pit-${index}`);
            if (index === 6 || index === 13) {
                pitEl.querySelector('.store-label').innerText = count;
            } else {
                pitEl.parentElement.querySelector('.seed-count').innerText = count;
            }
        }

        function updateTurnMsg() {
            const msgEl = document.getElementById('turn-msg');
            if (!isGameActive) {
                let p1 = board[6], p2 = board[13];
                let text = "", color = "#fff";
                if (p1 > p2) { text = "红方获胜!"; color = "#e74c3c"; }
                else if (p2 > p1) { text = "蓝方获胜!"; color = "#3498db"; }
                else { text = "平局!"; color = "#ddd"; }
                msgEl.innerText = text;
                msgEl.style.color = color;
                msgEl.style.border = `2px solid ${color}`;
                return;
            }

            if (currentPlayer === 0) {
                msgEl.innerText = "红方回合 (你)";
                msgEl.style.color = "#ff7675";
                msgEl.style.borderColor = "rgba(255, 118, 117, 0.5)";
            } else {
                msgEl.innerText = gameMode === 'pve' ? "电脑思考中..." : "蓝方回合";
                msgEl.style.color = "#74b9ff";
                msgEl.style.borderColor = "rgba(116, 185, 255, 0.5)";
            }
            highlightActivePits();
        }

        function highlightActivePits() {
            document.querySelectorAll('.pit').forEach(p => p.classList.remove('active-turn'));
            if (!isGameActive || isAnimating) return;
            if (currentPlayer === 0) {
                for(let i=0; i<=5; i++) if(board[i]>0) document.getElementById(`pit-${i}`).classList.add('active-turn');
            } else if (gameMode === 'pvp') {
                for(let i=7; i<=12; i++) if(board[i]>0) document.getElementById(`pit-${i}`).classList.add('active-turn');
            }
        }

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function getCenterCoords(element) {
            const rect = element.getBoundingClientRect();
            return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
        }

        function animateGemFly(fromIndex, toIndex) {
            return new Promise((resolve) => {
                const fromEl = document.getElementById(`pit-${fromIndex}`);
                const toEl = document.getElementById(`pit-${toIndex}`);
                const start = getCenterCoords(fromEl);
                const end = getCenterCoords(toEl);

                const flyer = document.createElement('div');
                const colorVar = GEM_COLORS[Math.floor(Math.random() * GEM_COLORS.length)];
                flyer.className = 'flying-gem';
                flyer.style.setProperty('--gem-color', colorVar);
                flyer.style.left = `${start.x - 13}px`;
                flyer.style.top = `${start.y - 13}px`;
                document.body.appendChild(flyer);

                void flyer.offsetHeight; 
                flyer.style.left = `${end.x - 13}px`;
                flyer.style.top = `${end.y - 13}px`;

                setTimeout(() => {
                    flyer.remove();
                    toEl.appendChild(createStaticGem(toIndex));
                    resolve();
                }, 400);
            });
        }

        async function clickPit(index) {
            if (!isGameActive || isAnimating) return;
            if (currentPlayer === 0) {
                if (index < 0 || index > 5) return;
            } else {
                if (gameMode === 'pve') return;
                if (index < 7 || index > 12) return;
            }
            if (board[index] === 0) return;
            await runTurnSequence(index);
        }

        async function runTurnSequence(startIndex) {
            isAnimating = true;
            highlightActivePits();

            let seeds = board[startIndex];
            board[startIndex] = 0;
            updatePitNumber(startIndex, 0);
            document.getElementById(`pit-${startIndex}`).innerHTML = ''; 

            let currentIndex = startIndex;
            let myStore = currentPlayer === 0 ? 6 : 13;
            let oppStore = currentPlayer === 0 ? 13 : 6;

            for (let i = 0; i < seeds; i++) {
                currentIndex = (currentIndex + 1) % 14;
                if (currentIndex === oppStore) currentIndex = (currentIndex + 1) % 14;

                await animateGemFly(startIndex, currentIndex);
                board[currentIndex]++;
                updatePitNumber(currentIndex, board[currentIndex]);
                await wait(70);
            }

            let nextPlayer = currentPlayer === 0 ? 1 : 0;
            
            if (currentIndex === myStore) {
                nextPlayer = currentPlayer;
                const storeEl = document.getElementById(`pit-${myStore}`);
                storeEl.style.boxShadow = "0 0 30px #ffd700";
                setTimeout(() => storeEl.style.boxShadow = "", 400);
            } else {
                let isOwnSide = (currentPlayer === 0 && currentIndex >= 0 && currentIndex <= 5) ||
                                (currentPlayer === 1 && currentIndex >= 7 && currentIndex <= 12);
                
                if (isOwnSide && board[currentIndex] === 1) {
                    let oppositeIndex = 12 - currentIndex;
                    if (board[oppositeIndex] > 0) {
                        await animateCapture(currentIndex, oppositeIndex, myStore);
                    }
                }
            }

            if (checkEndGame()) {
                finishGame();
            } else {
                currentPlayer = nextPlayer;
                isAnimating = false;
                updateTurnMsg();
                if (currentPlayer === 1 && gameMode === 'pve' && isGameActive) {
                    setTimeout(aiMove, 800);
                }
            }
        }

        async function animateCapture(myPitIdx, oppPitIdx, storeIdx) {
            let captureAmount = board[oppPitIdx] + board[myPitIdx];
            board[myPitIdx] = 0;
            board[oppPitIdx] = 0;
            board[storeIdx] += captureAmount;

            updatePitNumber(myPitIdx, 0);
            updatePitNumber(oppPitIdx, 0);
            document.getElementById(`pit-${myPitIdx}`).innerHTML = '';
            document.getElementById(`pit-${oppPitIdx}`).innerHTML = '';

            const promises = [];
            let visualFly = Math.min(captureAmount, 8);
            for(let i=0; i<visualFly; i++) promises.push(animateGemFly(oppPitIdx, storeIdx));
            await Promise.all(promises);
            
            updatePitNumber(storeIdx, board[storeIdx]);
            const storeEl = document.getElementById(`pit-${storeIdx}`);
            const curr = storeEl.querySelectorAll('.gem').length;
            for(let i=0; i < (captureAmount - visualFly); i++) {
                if (curr + i > 24) break;
                storeEl.appendChild(createStaticGem(storeIdx));
            }
        }

        function checkEndGame() {
            let p1Empty = true, p2Empty = true;
            for(let i=0; i<=5; i++) if(board[i] > 0) p1Empty = false;
            for(let i=7; i<=12; i++) if(board[i] > 0) p2Empty = false;
            return p1Empty || p2Empty;
        }

        function finishGame() {
            let p1Rem = 0, p2Rem = 0;
            for(let i=0; i<=5; i++) { p1Rem += board[i]; board[i] = 0; }
            for(let i=7; i<=12; i++) { p2Rem += board[i]; board[i] = 0; }
            board[6] += p1Rem; board[13] += p2Rem;
            isGameActive = false;
            isAnimating = false;
            renderBoardFull();
            updateTurnMsg();
        }

        // AI Logic
        function aiMove() {
            if(!isGameActive) return;
            let valid = [];
            for(let i=7; i<=12; i++) if(board[i]>0) valid.push(i);
            if(valid.length===0) return;
            let move = valid[Math.floor(Math.random()*valid.length)];
            if(aiLevel!=='easy') move = getBestMove(aiLevel==='hard'?4:2);
            runTurnSequence(move);
        }

        function simulate(bd, m, p) {
            let t = [...bd];
            let s = t[m]; t[m]=0;
            let idx = m;
            let ms = p===0?6:13; let os = p===0?13:6;
            while(s>0) {
                idx=(idx+1)%14;
                if(idx===os) continue;
                t[idx]++; s--;
            }
            let nxt = (p===0)?1:0;
            if(idx===ms) nxt=p;
            else {
                let isOwn = (p===0&&idx<=5)||(p===1&&idx>=7&&idx<=12);
                if(isOwn && t[idx]===1 && t[12-idx]>0) {
                    t[ms] += t[12-idx]+1; t[idx]=0; t[12-idx]=0;
                }
            }
            return {b:t, n:nxt};
        }

        function getBestMove(depth) {
            let bestSc = -Infinity; let bestM = -1;
            let moves = [];
            for(let i=7; i<=12; i++) if(board[i]>0) moves.push(i);
            moves.reverse();
            for(let m of moves) {
                let r = simulate(board, m, 1);
                let sc = minimax(r.b, depth-1, -Infinity, Infinity, r.n===1);
                if(sc>bestSc) { bestSc=sc; bestM=m; }
            }
            return bestM;
        }

        function minimax(bd, d, a, b, max) {
            if(d===0) return bd[13]-bd[6];
            if(max) {
                let v = -Infinity;
                for(let i=7; i<=12; i++) {
                    if(bd[i]===0) continue;
                    let r = simulate(bd, i, 1);
                    v = Math.max(v, minimax(r.b, d-(r.n===1?0:1), a, b, r.n===1));
                    a = Math.max(a, v); if(b<=a) break;
                }
                return v===-Infinity ? bd[13]-bd[6] : v;
            } else {
                let v = Infinity;
                for(let i=0; i<=5; i++) {
                    if(bd[i]===0) continue;
                    let r = simulate(bd, i, 0);
                    v = Math.min(v, minimax(r.b, d-(r.n===0?0:1), a, b, r.n===0));
                    b = Math.min(b, v); if(b<=a) break;
                }
                return v===Infinity ? bd[13]-bd[6] : v;
            }
        }

        const modal = document.getElementById('setup-modal');
        const rules = document.getElementById('rules-modal');
        function showMainMenu() {
            modal.classList.add('show');
            document.getElementById('mode-select').style.display = 'block';
            document.getElementById('diff-select').style.display = 'none';
        }
        function selectMode(m) {
            gameMode = m;
            if(m==='pve') {
                document.getElementById('mode-select').style.display = 'none';
                document.getElementById('diff-select').style.display = 'block';
            } else {
                modal.classList.remove('show');
                initGame();
            }
        }
        function startGame(d) {
            aiLevel = d;
            modal.classList.remove('show');
            initGame();
        }
        function backToMode() {
            document.getElementById('mode-select').style.display = 'block';
            document.getElementById('diff-select').style.display = 'none';
        }
        function showRules() { rules.classList.add('show'); }
        rules.onclick = (e) => { if(e.target===rules) rules.classList.remove('show'); }

    </script>
</body>
</html>